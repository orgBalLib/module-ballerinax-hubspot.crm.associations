name: Analyze Version Change

on:
  workflow_dispatch:
  repository_dispatch:
    types: [analyze-connector-changes]

jobs:
  analyze:
    name: Analyze connector version changes
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Set up Ballerina
        uses: ballerina-platform/setup-ballerina@v1.1.0
        with:
          version: latest

      - name: Generate git diff for client.bal and types.bal
        id: diff
        run: |
          # Generate diff between main and auto-generate-connector branches
          echo "Generating diff between origin/main and origin/auto-generate-connector..."

          # Generate diff for client.bal
          git diff origin/main..origin/auto-generate-connector -- ballerina/client.bal > client_diff.txt || true

          # Generate diff for types.bal
          git diff origin/main..origin/auto-generate-connector -- ballerina/types.bal > types_diff.txt || true

          # Combine diffs
          cat client_diff.txt types_diff.txt > git_diff.txt

          # Check if diff is not empty
          if [ ! -s git_diff.txt ]; then
            echo "No changes detected in client.bal or types.bal"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "Diff generated successfully"
          echo "Client diff size: $(wc -c < client_diff.txt) bytes"
          echo "Types diff size: $(wc -c < types_diff.txt) bytes"
          echo "Combined diff size: $(wc -c < git_diff.txt) bytes"

          # Show first 100 lines of diff for debugging
          echo "--- First 100 lines of diff ---"
          head -100 git_diff.txt

      - name: Run analysis
        if: steps.diff.outputs.has_changes == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Read the diff content
          DIFF_CONTENT=$(cat git_diff.txt)

          # Run the Ballerina analysis script
          cd scripts
          bal run analyze_version_change.bal -- "$DIFF_CONTENT"
          mv analysis_result.json ../

      - name: Display results
        if: always()
        run: |
          if [ -f analysis_result.json ]; then
            echo "Analysis Results:"
            cat analysis_result.json | jq '.'
          else
            echo "No analysis result file found"
          fi

      - name: Update version in gradle.properties
        if: steps.diff.outputs.has_changes == 'true'
        id: update_version
        run: |
          # Stash any existing changes first
          git stash || true

          # Checkout the auto-generate-connector branch
          git checkout auto-generate-connector

          # Read the analysis result
          CHANGE_TYPE=$(jq -r '.changeType' analysis_result.json)

          # Get current version from gradle.properties
          CURRENT_VERSION=$(grep '^version=' gradle.properties | cut -d'=' -f2)
          echo "Current version: $CURRENT_VERSION"

          # Remove -SNAPSHOT suffix if present
          BASE_VERSION=$(echo $CURRENT_VERSION | sed 's/-SNAPSHOT//')

          # Split version into major.minor.patch
          IFS='.' read -r MAJOR MINOR PATCH <<< "$BASE_VERSION"

          # Increment based on change type
          case $CHANGE_TYPE in
            MAJOR)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            MINOR)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            PATCH)
              PATCH=$((PATCH + 1))
              ;;
            *)
              echo "Unknown change type: $CHANGE_TYPE"
              exit 1
              ;;
          esac

          # Create new version with -SNAPSHOT suffix
          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}-SNAPSHOT"
          echo "New version: $NEW_VERSION"

          # Update gradle.properties
          sed -i "s/^version=.*/version=$NEW_VERSION/" gradle.properties

          # Output for later steps
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "change_type=$CHANGE_TYPE" >> $GITHUB_OUTPUT

      - name: Set up Java
        if: steps.diff.outputs.has_changes == 'true'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Run Gradle build to generate Ballerina files
        if: steps.diff.outputs.has_changes == 'true'
        env:
          packageUser: ${{ github.actor }}
          packagePAT: ${{ secrets.PAT_TOKEN }}
        run: |
          # Run Gradle build which will use build-config/resources/Ballerina.toml
          # and generate the correct Ballerina.toml and Dependencies.toml in ballerina/ folder
          ./gradlew build -x test

          echo "Generated Ballerina files:"
          ls -la ballerina/Ballerina.toml ballerina/Dependencies.toml || true

          echo "--- Ballerina.toml content ---"
          cat ballerina/Ballerina.toml || true

      - name: Commit version changes and generated files
        if: steps.diff.outputs.has_changes == 'true'
        run: |
          git config --local user.email "ballerina-bot@ballerina.io"
          git config --local user.name "ballerina-bot"

          # Add gradle.properties and generated Ballerina files
          git add gradle.properties
          git add ballerina/Ballerina.toml
          git add ballerina/Dependencies.toml

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update version to ${{ steps.update_version.outputs.new_version }} and regenerate Ballerina files"
          fi

          git push origin auto-generate-connector

      - name: Create Pull Request
        if: steps.diff.outputs.has_changes == 'true'
        id: create_pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            const fs = require('fs');
            const analysis = JSON.parse(fs.readFileSync('analysis_result.json', 'utf8'));

            let prBody = `## üìä Version Change Analysis\n\n`;
            prBody += `**Recommended Version Bump:** \`${analysis.changeType}\`\n`;
            prBody += `**New Version:** \`${{ steps.update_version.outputs.new_version }}\`\n`;
            prBody += `**Confidence:** ${analysis.confidence}\n\n`;
            prBody += `### Summary\n${analysis.summary}\n\n`;

            if (analysis.breakingChanges.length > 0) {
              prBody += `### ‚ö†Ô∏è Breaking Changes\n`;
              analysis.breakingChanges.forEach(change => {
                prBody += `- ${change}\n`;
              });
              prBody += '\n';
            }

            if (analysis.newFeatures.length > 0) {
              prBody += `### ‚ú® New Features\n`;
              analysis.newFeatures.forEach(feature => {
                prBody += `- ${feature}\n`;
              });
              prBody += '\n';
            }

            if (analysis.bugFixes.length > 0) {
              prBody += `### üêõ Improvements\n`;
              analysis.bugFixes.forEach(fix => {
                prBody += `- ${fix}\n`;
              });
              prBody += '\n';
            }

            prBody += `---\n\n`;
            prBody += `üîç **Manual Review Required** - Please review the changes and approve if appropriate.\n`;

            // Create PR
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[${analysis.changeType}] Auto-generated connector update - v${{ steps.update_version.outputs.new_version }}`,
              head: 'auto-generate-connector',
              base: 'main',
              body: prBody
            });

            console.log(`Created PR #${pr.data.number}`);
            core.setOutput('pr_number', pr.data.number);
            core.setOutput('pr_url', pr.data.html_url);

            return pr.data.number;

      - name: Add manual review label
        if: steps.diff.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.create_pr.outputs.result }},
              labels: ['manual-review-required']
            });

      - name: Send email notification
        if: steps.diff.outputs.has_changes == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.GMAIL_USERNAME }}
          password: ${{ secrets.GMAIL_APP_PASSWORD }}
          subject: "üîî Version Analysis Complete - ${{ steps.update_version.outputs.change_type }} Update Required"
          to: t37714687@gmail.com
          from: ${{ secrets.GMAIL_USERNAME }}
          body: |
            Version Analysis Complete

            Repository: ${{ github.repository }}
            Change Type: ${{ steps.update_version.outputs.change_type }}
            New Version: ${{ steps.update_version.outputs.new_version }}

            Pull Request: ${{ steps.create_pr.outputs.pr_url }}

            Summary:
            ${{ steps.display_results.outputs.summary }}

            Please review the PR for detailed changes.

            This is an automated message from GitHub Actions.
          html_body: |
            <!DOCTYPE html>
            <html>
            <head>
              <style>
                body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
                .container { max-width: 600px; margin: 0 auto; padding: 20px; }
                .header { background-color: #0366d6; color: white; padding: 20px; border-radius: 5px; }
                .content { background-color: #f6f8fa; padding: 20px; margin-top: 20px; border-radius: 5px; }
                .badge { display: inline-block; padding: 5px 10px; border-radius: 3px; font-weight: bold; }
                .major { background-color: #d73a49; color: white; }
                .minor { background-color: #0366d6; color: white; }
                .patch { background-color: #28a745; color: white; }
                .button { display: inline-block; padding: 10px 20px; background-color: #0366d6; color: white; text-decoration: none; border-radius: 5px; margin-top: 15px; }
                .footer { margin-top: 20px; font-size: 12px; color: #666; }
              </style>
            </head>
            <body>
              <div class="container">
                <div class="header">
                  <h2>üìä Version Analysis Complete</h2>
                </div>
                <div class="content">
                  <p><strong>Repository:</strong> ${{ github.repository }}</p>
                  <p><strong>Change Type:</strong> <span class="badge ${{ steps.update_version.outputs.change_type == 'MAJOR' && 'major' || steps.update_version.outputs.change_type == 'MINOR' && 'minor' || 'patch' }}">${{ steps.update_version.outputs.change_type }}</span></p>
                  <p><strong>New Version:</strong> ${{ steps.update_version.outputs.new_version }}</p>

                  <p>A pull request has been created for your review:</p>
                  <a href="${{ steps.create_pr.outputs.pr_url }}" class="button">View Pull Request</a>

                  <p style="margin-top: 20px;"><strong>‚ö†Ô∏è Manual Review Required</strong><br>
                  Please review the changes carefully before merging.</p>
                </div>
                <div class="footer">
                  <p>This is an automated message from GitHub Actions.</p>
                </div>
              </div>
            </body>
            </html>

      - name: Upload analysis results
        if: steps.diff.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: version-analysis
          path: |
            analysis_result.json
            git_diff.txt
            client_diff.txt
            types_diff.txt

      - name: Comment on PR (for repository_dispatch events)
        if: github.event_name == 'repository_dispatch' && steps.diff.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            const fs = require('fs');

            if (!fs.existsSync('analysis_result.json')) {
              console.log('No analysis result found');
              return;
            }

            const analysis = JSON.parse(fs.readFileSync('analysis_result.json', 'utf8'));

            let comment = `## üìä Version Change Analysis\n\n`;
            comment += `**Recommended Version Bump:** \`${analysis.changeType}\`\n`;
            comment += `**New Version:** \`${{ steps.update_version.outputs.new_version }}\`\n`;
            comment += `**Confidence:** ${analysis.confidence}\n\n`;
            comment += `### Summary\n${analysis.summary}\n\n`;

            if (analysis.breakingChanges.length > 0) {
              comment += `### ‚ö†Ô∏è Breaking Changes\n`;
              analysis.breakingChanges.forEach(change => {
                comment += `- ${change}\n`;
              });
              comment += '\n';
            }

            if (analysis.newFeatures.length > 0) {
              comment += `### ‚ú® New Features\n`;
              analysis.newFeatures.forEach(feature => {
                comment += `- ${feature}\n`;
              });
              comment += '\n';
            }

            if (analysis.bugFixes.length > 0) {
              comment += `### üêõ Improvements\n`;
              analysis.bugFixes.forEach(fix => {
                comment += `- ${fix}\n`;
              });
            }

            const prNumber = context.payload.client_payload?.pr_number;

            if (prNumber) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
            }
